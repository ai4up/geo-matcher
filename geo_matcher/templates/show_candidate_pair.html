{% extends "base.html" %}

{% block title %}Label Candidate Pair{% endblock %}

{% block body %}
<div id="nav-bar">
    <a href="/" class="nav-link">Home</a>
    <a href="/download-results" class="nav-link">Download Results</a>

    <span class="nav-divider"></span>

    <a href="/show-pair" class="nav-link active">Pair-wise Labeling</a>
    <a href="/show-neighborhood" class="nav-link">Neighborhood-wise Labeling</a>
</div>


<div id="map">
    <iframe src="{{ url_for('static', filename='maps/' + map_file | string ) }}" width="100%" height="100%"></iframe>
</div>

<div id="buttons">
    <button class="btn btn-match" onclick="labelPair('{{ id_existing }}', '{{ id_new }}', 'yes')">Match</button>
    <button class="btn btn-no-match" onclick="labelPair('{{ id_existing }}', '{{ id_new }}', 'no')">No Match</button>
    <button class="btn btn-unsure" onclick="labelPair('{{ id_existing }}', '{{ id_new }}', 'unsure')">Unsure</button>
</div>

<div id="legend">
    <h4>Keyboard Shortcuts</h4>
    <ul>
        <li><kbd>&rarr;</kbd> Match</li>
        <li><kbd>&larr;</kbd> No Match</li>
        <li><kbd>&darr;</kbd> Unsure</li>
        <li><kbd>&uarr;</kbd> Back</li>
        <li><kbd>?</kbd> Toggle Legend</li>
    </ul>
    <button onclick="toggleLegend()">Close</button>
</div>

<div id="scoreboard">
    <div id="scoreboard-header" class="score-entry">
        <div class="score-user">User</div>
        <div class="score-count">Count</div>
        <div class="score-kappa tooltip-container">
            <span>κ</span>
            <span class="custom-tooltip" role="tooltip">Inter-Annotator Agreement<br>(Cohen's Kappa)</span>
        </div>
    </div>

    <div id="scoreboard-entries">
        {% for entry in user_stats %}
            <div class="score-entry">
                <div class="score-user">{{ entry.username }}</div>
                <div class="score-count">{{ entry.count }}</div>
                <div class="score-kappa">
                    {% if entry.kappa == entry.kappa %}
                        <span class="tooltip-container">
                            <span class="kappa-value {{ entry.kappa_class }}" data-kappa="{{ entry.kappa }}">
                                {{ '%.2f'|format(entry.kappa) }}
                            </span>
                            <span class="custom-tooltip" role="tooltip">Inter-Annotator Agreement<br>(Cohen's Kappa)</span>
                        </span>
                    {% else %}
                        —
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<div id="label-feedback"></div>
{% endblock %}

{% block scripts %}
<script type="text/javascript">
    document.addEventListener('keydown', function(event) {
        event.preventDefault();
        if (event.key === "ArrowUp") {
            window.history.back();
        } else if (event.key === "ArrowDown") {
            displayText('unsure');
            labelPair('{{ id_existing }}', '{{ id_new }}', 'unsure');
        } else if (event.key === "ArrowRight") {
            displayText('match');
            labelPair('{{ id_existing }}', '{{ id_new }}', 'yes');
        } else if (event.key === "ArrowLeft") {
            displayText('nomatch');
            labelPair('{{ id_existing }}', '{{ id_new }}', 'no');
        } else if (event.key === "?") {
            toggleLegend();
        }
    });

    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll('.kappa-value').forEach(el => {
            const kappa = parseFloat(el.dataset.kappa);
            if (!isNaN(kappa)) {
                if (kappa >= 0.8) {
                    el.classList.add('kappa-excellent');
                } else if (kappa >= 0.6) {
                    el.classList.add('kappa-high');
                } else if (kappa >= 0.4) {
                    el.classList.add('kappa-medium');
                } else {
                    el.classList.add('kappa-low');
                }
            }
        });
    });

    function labelPair(id_existing, id_new, match) {
        fetch('/store-label', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                id_existing: id_existing,
                id_new: id_new,
                match: match
            })
        })
        .then(response => response.json())
        .then(data => {
            window.location.href = `/show-pair/${data.next_existing_id}/${data.next_new_id}`;
        });
    }

    function toggleLegend() {
        const legend = document.getElementById('legend');
        if (legend.style.display === 'block') {
            legend.style.display = 'none';
        } else {
            legend.style.display = 'block';
        }
    }

    function displayText(label) {
        const feedback = document.getElementById('label-feedback');
        feedback.className = label; // 'match', 'nomatch', 'unsure'
        feedback.textContent = label === 'match' ? 'Match' :
                                label === 'nomatch' ? 'No Match' : 'Unsure';

        feedback.style.opacity = '1';

        setTimeout(() => {
            feedback.style.opacity = '0';
        }, 300);  // Quickly fades out
    }
</script>
{% endblock %}
